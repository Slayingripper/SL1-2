services:
  pv-controller:
    build: .
    image: scl-challenge-smart-home-pv
    container_name: scl-challenge-smart-home-pv
    restart: unless-stopped
    networks:
      playground-net:
        ipv4_address: 172.20.0.65
    ports:
      - "8081:80"  # Expose PV controller admin dashboard
      - "15002:15002" # Expose Modbus TCP for external tools using 15002
    environment:
      - MQTT_HOST=mosquitto
      - MODBUS_PORT=15002
      - BLOCK_TTL_SECONDS=60
      - LOG_LEVEL=WARNING
      - MQTT_TELEMETRY_INTERVAL=3
      - MQTT_STATUS_INTERVAL=30
      - DOCUMENTS_DIR=/opt/pv-controller/Documents
    volumes:
      - ./logs:/opt/pv-controller/logs
      - ${HOME}/Documents:/opt/pv-controller/Documents
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "2"
    healthcheck:
      test: ["CMD", "python3", "-c", "import socket; s=socket.socket(); s.connect(('127.0.0.1',80)); s.close()"]
      interval: 20s
      timeout: 5s
      retries: 3

  mosquitto:
    image: eclipse-mosquitto:2.0
    container_name: scl-challenge-mosquitto
    restart: unless-stopped
    networks:
      playground-net:
        ipv4_address: 172.20.0.66
    ports:
      - "9001:9001"  # WebSocket for React dashboard
    volumes:
      - ./mosquitto-config/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "2"
    healthcheck:
      test: ["CMD", "sh", "-c", "mosquitto_sub -h 127.0.0.1 -t '$$SYS/#' -C 1 -W 1 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3

  noise:
    build:
      context: ./tools/noise
    image: scl-challenge-smart-home-pv-noise
    container_name: scl-challenge-smart-home-pv-noise
    restart: unless-stopped
    networks:
      playground-net:
        ipv4_address: 172.20.0.71
    environment:
      - MQTT_HOST=mosquitto
    volumes:
      - ./logs:/opt/pv-controller/logs
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "2"
    depends_on:
      - mosquitto
      - pv-controller
  victim:
    build:
      context: ./tools/victim
    image: scl-challenge-smart-home-pv-victim
    container_name: scl-challenge-smart-home-pv-victim
    restart: unless-stopped
    networks:
      playground-net:
        ipv4_address: 172.20.0.72
    environment:
      PV_URL: http://pv-controller
      PV_HOST: pv-controller
      PV_BASE_URL: http://pv-controller
    volumes:
      - ./logs:/opt/pv-controller/logs
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "2"
    depends_on:
      - pv-controller
    tty: true
    command: ["node", "victim_cyber_range.js"]
  telemetry-seeder:
    build:
      context: ./tools/noise
    image: scl-challenge-smart-home-pv-seeder
    container_name: scl-challenge-smart-home-pv-seeder
    restart: 'no'
    networks:
      playground-net:
        ipv4_address: 172.20.0.73
    environment:
      - MQTT_HOST=mosquitto
    volumes:
      - ./logs:/opt/pv-controller/logs
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "2"
    command: ["python","noise_generator.py","--seed"]
  replayer:
    build:
      context: ./tools/replayer
    image: scl-challenge-smart-home-pv-replayer
    container_name: scl-challenge-smart-home-pv-replayer
    restart: unless-stopped
    networks:
      playground-net:
        ipv4_address: 172.20.0.74
    environment:
      - PV_SERVER=http://pv-controller
      - PCAP_PATH=/opt/pv-controller/logs/modbus.pcap
      - REPLAYER_POLL_INTERVAL=3
    depends_on:
      - pv-controller
    volumes:
      - ./logs:/opt/pv-controller/logs
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "2"

networks:
  playground-net:
    external: true
